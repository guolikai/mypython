<!DOCTYPE html>
<!-- saved from url=(0048)http://v3.bootcss.com/examples/navbar-fixed-top/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!--link rel="icon" href="http://v3.bootcss.com/favicon.ico" -->

    <title>抽屉新热榜</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/css/navbar-fixed-top.css" rel="stylesheet">
    <link href="/static/css/customize.css" rel="stylesheet">

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container ">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">抽屉</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">全部</a></li>
			<li class="active"><a href="#">1024区</a></li>
			<li class="active"><a href="#">IT</a></li>
			<li class="active"><a href="#">云计算</a></li>
            {% for category in bbs_category%}
                {% ifequal category.id  cata_id %}
                    <li class="active"><a href="/category/{{category.id}}/">{{category.name}}</a></li>
                {%else%}
                     <li class=""><a href="/category/{{category.id}}/">{{category.name}}</a></li>  
                {%endifequal%}
            {%endfor %}
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle  pull-right" data-toggle="dropdown">
                {% if user.is_authenticated%}
                <!--  {{user.username}}-->
                {{username}}
              {%else%} 
                登陆
               {%endif%}
  
               <span class="caret "></span></a>
              <ul class="dropdown-menu" role="menu">
               <li><a href="/login/">Login</a></li>
                <li><a href="/logout/">Logout</a></li>
              </ul>
            </li>
          </ul>

        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container  center-container-hx ">
    
        {% block page-content %}
        <!-- Main component for a primary marketing message or call to action -->
		<div class="contents">
			<div class='part1'>
			  {% for bbs in bbs_list  %}
				<!--  
				<a href="/detail/{{bbs.id}}/" >{{bbs.title}}</a>
				<br>
				{{bbs.summary}}-->
				<a href="{{bbs.url}}" target="_blank" >{{bbs.title}}</a>
				<br></div>
				   
			<div class='part2'>
				{{bbs.summary}}</div> 
			<div class='part3'>
				<a href="#" onclick='Favor(this,{{bbs.id}});'>赞 {{bbs.favor_count}}</a>
				<a href="#" id='replay' onclick='Reply(this,{{bbs.id}});'>评论 {{bbs.reply_count}} </a>
				<span>{{bbs.create_date|date:'Y-m-d H:i:s'}}</span></div> 
			<div has_input='0' class='part4 hide'>
				<div class='replys'></div>
				<div class='input'>
					<labal>请输入评论内容:</label>
					<textarea></textarea>
					<input type='button' value='提交' onclick='Submitreply(this,{{bbs.id}});'/>
				</div>
			</div>
				<hr>
			  {%endfor%}
		</div>
        {% endblock %}
    </div> 
	<div class='right chat'>
		<div class='title'>
			新热榜V1.0
		</div>
		<div id='chatpool' content='content'>
		
		</div>
		
		<div class='bottom clearfix'>
			<div class='left msg'>
				<textarea id='message' class='text'></textarea>
			</div>
			<div class='left submit'>
				<input type='button' class='btn' onclick='SendMsg();' value='发送'/>
			</div>
		
		</div>
	
	
	
	</div>
	<script src="/static/js/jquery-2.1.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
	<script type='text/javascript'>
		function Favor(doc,id){
			//后台数据点赞+1;
			$.ajax({
				url:'/addfavor/',
				data:{nid:id},
				type:'POST',
				success:function(callback){
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
					var temp = '赞'+obj.data
						$(doc).text(temp);
					}else{
						alert(obj.message);}
				}
			});
		}
		
		function Reply(doc,id){
			$.ajax({
				url:'/getreply/',
				data:{nid:id},
				type:'POST',
				success:function(callback){
					//console.log(callback);
					var obj = jQuery.parseJSON(callback);
					//temp = console.log(obj[1].content);
					//console.log(obj)
					$(doc).parent().next().find('.replys').empty();
					$.each(obj,function(k,v){
						//$(doc).parent().next().first().text('0000000');
						//console.log(v.content)
						temp = "<div>"+v.user__username+":"+v.content+"  ---@"+v.create_date+"</div>";
						$(doc).parent().next().find('.replys').append(temp);	
					});
				}
			});
			$(doc).parent().next().toggleClass('hide');
		}
		
		function Submitreply(doc,id){
			
			$.ajax({
				url:'/submitreply/',
				data:{nid:id,data:$(doc).prev().val()},
				type:'POST',
				success:function(callback){	
					//console.log(callback)
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
					//把数据append到评论列表
						var temp = "<div>"+obj.data.user__username+":"+obj.data.content+"  ---@"+obj.data.create_date+"</div>";
						var temp1 = '评论' + obj.data.count
						$(doc).parent().parent().prev().children('replay').text(temp1);
						$(doc).parent().prev().append(temp);
					}else{
						alert('操作失败.');}
				}
			});	
		}
		
		function SendMsg(){
			//val value=$('#message').val();
			$.ajax({
				url:'/submitchat/',
				data:{data:$('#message').val()},
				type:'POST',
				success:function(callback){
					console.log(callback)
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
						var name=obj.data.username
						var now=obj.data.create_date
						var template = "<div><div>"+name+"---@"+now+"</div><div>"+$('#message').val()+"</div></div>";
						$('#chatpool').append(template);
						window.last_id = obj[obj.length-1].id
						var height = document.getElementById('chatpool')
						$('#chatpool').scrollTop(height)
					}else{
						alert('操作失败.');}
				}
			});	
			//$('#message').val('')
		}
		setInterval('going()',2000);
		window.is_first = true
		function going(){
			if(is_first){
				$.ajax({
					url:'/getchat/',
					type:'POST',
					success:function(callback){
						//console.log(callback);
						var obj = jQuery.parseJSON(callback);
						window.last_id = obj[0].id
						obj = obj.reverse();
						$.each(obj,function(k,v){
							var name=v.user__username
							var now=v.create_date
							var value=v.content
							var template = "<div><div>"+name+"---@"+now+"</div><div>"+value+"</div></div>";
							$('#chatpool').append(template);	
						});
						window.is_first = false
						var height = document.getElementById('chatpool')
						$('#chatpool').scrollTop(height)
					}
				});
			}else{
				$.ajax({
					url:'/getchat2/',
					data:{'lastid':window.last_id},
					type:'POST',
					success:function(callback){
						//console.log(callback);
						var obj = jQuery.parseJSON(callback);
						if(obj.length-1>0){
							window.last_id = obj[obj.length-1].id
							$.each(obj,function(k,v){
								var name=v.user__username
								var now=v.create_date
								var value=v.content
								var template = "<div><div>"+name+"---@"+now+"</div><div>"+value+"</div></div>";
								$('#chatpool').append(template);
							});

						}	
						var height = document.getElementById('chatpool')
						$('#chatpool').scrollTop(height)
					}
				});
			}
		}
	</script>
</body></html>